<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="../../general/schematron/NictizTestScript.sch" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<TestScript xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript" nts:scenario="server">
    
    <id value="Sending-XIS-scenario1.1"/>
    <version value="stu3-4.0"/>
    <name value="eOverdracht receiving system - scenario 1.1 "/>
    <description value="Test for eOverdracht sending systems according to qualification scenario 1.1"/>
    
    <nts:patientTokenFixture href="eOverdracht-patient-XXX_Altenborg-token.xml"/>
    
    <setup in-targets="internal">
        <nts:fixture
            id="initial-task-fixture"
            href="resources/resources-specific/eOverdracht-Task-scenario1_1-ACCEPTED.xml"/>
        <nts:include value="setup.initializeTask.general"/>
    </setup>
    
    <nts:include value="action.awaitNotification.sendingxis" nts:in-targets="#default">
        <nts:with-parameter name="name" value="Await notification for new Task"/>
    </nts:include>
    
    <test id="Scenario1.1-ServeTask">
        <name value="Scenario1.1 - Search for eOverdracht Task for patient XXX_Altenborg"/>
        <description value="Test sending XIS to serve eOverdracht Tasks which are new or changed since the last time the search was performed."/>
        <nts:include value="test.searchTasks.sendingxis">
            <nts:with-parameter name="expectedStatus" value="accepted"/>
            <nts:with-parameter name="responseId" value="search-accepted-tasks-response"/>
        </nts:include>
    </test>
    
    <test id="Scenario1.1-ServeNursingHandoff">
        <name value="Scenario1.1 - Serve NursingHandoff Composition"/>
        <description value="Scenario 1.1 - Test sending XIS to serve the nursing handoff Composition referenced in the eOverdracht Task."/>
        
        <nts:include value="variable.nursingHandoffIdFromTaskBundle.general">
            <nts:with-parameter name="taskStatus" value="accepted"/>
            <nts:with-parameter name="sourceId" value="search-accepted-tasks-response"/>
        </nts:include>
        
        <action>
            <operation>
                <type>
                    <system value="http://hl7.org/fhir/testscript-operation-codes" />
                    <code value="read" />
                </type>
                <resource value="Composition"/>
                <label value="RetrieveNursingHandoff"/>
                <destination value="1"/>
                <origin value="1"/>
                <params value="/${nursing-handoff-id}"/>
                <requestHeader>
                    <field value="Authorization" />
                    <value value="${patient-token-id}" />
                </requestHeader>
            </operation>
        </action>
        <nts:include value="assert-responseSuccess" scope="common"/>
        <nts:profile id="eOverdracht-NursingHandoff" value="http://nictiz.nl/fhir/StructureDefinition/eOverdracht-NursingHandoff-Adults"/>
        <action>
            <assert>
                <description value="Confirm that the Composition conforms to the eOverdracht Nursing Handoff profile"/>
                <direction value="response"/>
                <validateProfileId value="eOverdracht-NursingHandoff"/>
            </assert>
        </action>
    </test>

    <test id="Scenario1.1-RecieveTaskUpdate">
        <name value="Scenario1.1 - Handle update to eOverdracht Task"/>
        <description value="Test XIS server to handle an update to the eOverdracht Task with status 'completed'. This will be an update operation where the original Task is sent, with only the status element changed."/>

        <nts:fixture
            id="completed-task-fixture"
            href="resources/resources-specific/eOverdracht-Task-scenario1_1-COMPLETED.xml"/>
        <nts:include value="test.handleTaskUpdate.sendingxis">
            <nts:with-parameter name="expectedStatus" value="completed"/>
            <nts:with-parameter name="taskUpdateFixtureId" value="completed-task-fixture"/>
        </nts:include>
    </test>
    
</TestScript>
