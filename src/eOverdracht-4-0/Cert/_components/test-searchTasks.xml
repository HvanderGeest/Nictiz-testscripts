<?xml version="1.0" encoding="UTF-8"?>
<!--
    Test a receiving XIS to perform a search for new or updated eOverdracht Tasks.
    An assert is used to check if the `_lastUpdated` parameter is present. This parameter is not specified in the
    operation because the value of this parameter is not fixed. However, a version for internal tests (Nictiz-internal)
    is created that includes this parameter (based on the timestamp from the Task initialization). 
-->
<nts:component xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript">
    <variable nts:in-targets="Nictiz-internal">
        <name value="time-since-lastUpdated"/>
        <expression value="Task.meta.lastUpdated.replaceMatches('\\.[0-9]+','')"/>
        <sourceId value="setup-task-response"/>
    </variable>
    
    <action>
        <operation>
            <type>
                <system value="http://hl7.org/fhir/testscript-operation-codes" />
                <code value="search" />
            </type>
            <resource value="Task"/>
            <label value="Search Task resources for eOverdracht"/>
            <accept value="xml" />
            <contentType value="xml" />
            <destination value="1"/>
            <origin value="1"/>
            <params nts:in-targets="#default"
                value="?code=http://snomed.info/sct|308292007"/>
            <params nts:in-targets="Nictiz-internal"
                value="?code=http://snomed.info/sct|308292007&amp;_lastUpdated=ge${time-since-lastUpdated}"/>
            <requestHeader>
                <field value="Authorization" />
                <value value="${patient-token-id}" />
            </requestHeader>
        </operation>
    </action>
    <action>
        <assert>
            <label value="Check if the request URL contains the _lastUpdated parameter with the ge modifier"/>
            <operator value="contains"/>
            <requestURL value="query: ?_lastUpdated=ge"/>
        </assert>
    </action>
</nts:component>
