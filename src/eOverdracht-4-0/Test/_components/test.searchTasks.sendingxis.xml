<?xml version="1.0" encoding="UTF-8"?>
<!--
    Test a sending XIS to serve new and updated eOverdracht Tasks.
    @param workflowStartDateTime - The time the workflow is started and the Task has been prepared.
    @param expectedStatus - The expected status of the Task. This is needed for the sanity check that a single Task with the specified status is returned at this time in the process.
-->

<nts:component xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript">
    <variable nts:in-targets="#default">
        <name value="workflowStartDateTime"/>
        <description value="Datetime of the moment the eOverdracht flow was initiated. This datetime is used for the search operation."/>
        <hint value="A datetime formatted according to ISO 8601 (YYYY-MM-DDTHH:MM:ss)."/>
    </variable>
    <variable nts:in-targets="internal">
        <name value="workflowStartDateTime"/>
        <expression value="Task.meta.lastUpdated.replaceMatches('\\.[0-9]+','')"/>
        <sourceId value="setup-task-response"/>
    </variable>
        
    <action>
        <operation>
            <type>
                <system value="http://hl7.org/fhir/testscript-operation-codes" />
                <code value="search" />
            </type>
            <resource value="Task"/>
            <label value="Search Task resources for eOverdracht"/>
            <accept value="xml" />
            <contentType value="xml" />
            <destination value="1"/>
            <origin value="1"/>
            <params value="?code=http://snomed.info/sct|308292007&amp;_lastUpdated=ge${workflowStartDateTime}"/>
            <requestHeader>
                <field value="Authorization" />
                <value value="${patient-token-id}" />
            </requestHeader>
            <responseId value="{$responseId}"/>
        </operation>
    </action>
    <variable>
        <name value="task-{$expectedStatus}"/>
        <expression value="Bundle.entry.where(resource is Task).resource.where(status = '{$expectedStatus}')"/>
        <sourceId value="search-{$expectedStatus}-tasks-response"/>
    </variable>
    <nts:include value="assert-responseSuccess" scope="common"/>
    <nts:include value="assert-responseBundleContent" scope="common"/>
    <action>
        <assert>
            <label value="Sanity check to see if the result contains a single Task with status=requested. If this is not the case, there are multiple tests being performed which interfere with each other. Please try again at a later time."/>
            <expression value="Bundle.entry.where(resource is Task).resource.where(status = '{$expectedStatus}').count() = 1"/>
        </assert>
    </action>
</nts:component>

