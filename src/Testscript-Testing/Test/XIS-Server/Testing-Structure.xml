<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://hl7.org/fhir/STU3/testscript.sch" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<TestScript xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript"
    nts:scenario="server">
    <id value="Testing-structure"/>
    <version value="stu3-2.0"/>
    <name
        value="Testscript-Testing - XIS Server - Scenario 1.1 - Check fixture structure"/>
    <description value="Scenario 1.1 - Check fixture structure"/>
    <nts:patientTokenFixture href="medmij-bgz-ext-nl-core-patient-01-token.xml"/>

    <test id="Basic-tests">
        <name value="1.1 Basic-tests"/>
        <description value="Check if Identifier structure is correct"/>
        <action>
            <operation>
                <type>
                    <system value="http://terminology.hl7.org/CodeSystem/testscript-operation-codes"/>
                    <code value="search"/>
                </type>
                <resource value="Observation"/>
                <description value="Test XIS server to serve Observation resources."/>
                <accept value="xml"/>
                <destination value="1"/>
                <encodeRequestUrl value="true"/>
                <origin value="1"/>
                <params value="?code=http://loinc.org|8302-2"/>
                <requestHeader>
                    <field value="Authorization"/>
                    <value value="${patient-token-id}"/>
                </requestHeader>
                <requestHeader>
                    <field value="MedMij-Request-ID"/>
                    <value value="${UUID}"/>
                </requestHeader>
                <responseId value="search-observation"/>
            </operation>
        </action>
        <nts:include value="assert.response.numResources" scope="common" 
            resource="Observation" count="1"/>
    </test>
    
    <test id="Identifier">
        <name value="1.2 Identifier"/>
        <description value="Check if Identifier exists"/>
        <action>
            <assert>
                <description value="Confirm that at least 1 Identifier is present"/>
                <direction value="response"/>
                <expression value="Bundle.entry.resource.identifier.exists()"/>
                <sourceId value="search-observation"/>
            </assert>
        </action>
        <action>
            <assert>
                <description value="Confirm that all identifiers contain a system"/>
                <direction value="response"/>
                <expression value="Bundle.entry.resource.identifier.all(system.exists())"/>
                <sourceId value="search-observation"/>
            </assert>
        </action>
        <action>
            <assert>
                <description value="Confirm that all identifiers contain a value"/>
                <direction value="response"/>
                <expression value="Bundle.entry.resource.identifier.all(value.exists())"/>
                <sourceId value="search-observation"/>
            </assert>
        </action>
        <action>
            <assert>
                <description value="Confirm that all identifiers contain both a value and a system"/>
                <direction value="response"/>
                <expression value="Bundle.entry.resource.identifier.all((system.exists() or type.exists()) and value.exists())"/>
                <sourceId value="search-observation"/>
            </assert>
        </action>
    </test>

    <test id="Status">
        <name value="1.3 Status"/>
        <description value="Check if status structure is correct"/>
        <action>
            <assert>
                <description value="Confirm that a status is present"/>
                <direction value="response"/>
                <expression value="Bundle.entry.resource.status.exists()"/>
                <sourceId value="search-observation"/>
            </assert>
        </action>
    </test>

    <test id="Category">
        <name value="1.4 Category"/>
        <description value="Check if category structure is correct"/>
        <action>
            <assert>
                <description value="Confirm that a category is present"/>
                <direction value="response"/>
                <expression value="Bundle.entry.resource.category.exists()"/>
                <sourceId value="search-observation"/>
            </assert>
        </action>
        <action>
            <assert>
                <description value="Confirm that all categories contains a coding"/>
                <direction value="response"/>
                <expression value="Bundle.entry.resource.category.all(coding.exists())"/>
                <sourceId value="search-observation"/>
            </assert>
        </action>
        <action>
            <assert>
                <description value="Confirm that all the coding contains a system"/>
                <direction value="response"/>
                <expression value="Bundle.entry.resource.category.all(coding.system.exists())"/>
                <sourceId value="search-observation"/>
            </assert>
        </action>
        <action>
            <assert>
                <description value="Confirm that all the coding contains a code"/>
                <direction value="response"/>
                <expression value="Bundle.entry.resource.category.all(coding.code.exists())"/>
                <sourceId value="search-observation"/>
            </assert>
        </action>
        <action>
            <assert>
                <description value="Confirm that all the coding contains a display"/>
                <direction value="response"/>
                <expression value="Bundle.entry.resource.category.all(coding.display.exists())"/>
                <sourceId value="search-observation"/>
            </assert>
        </action>
        <action>
            <assert>
                <description value="Confirm that all the coding contains a system, code and display"/>
                <direction value="response"/>
                <expression value="Bundle.entry.resource.category.all(coding.system.exists() and coding.code.exists() and coding.display.exists())"/>
                <sourceId value="search-observation"/>
            </assert>
        </action>
    </test>
</TestScript>
