<!--
    Test if a response contains a resource that references a Medication resource with a specific system and code and if that response also includes that specific Medication resource.
    @param resourceType
    @param medicationCode
    @param medicationSystem - fallback is PRK
-->
<nts:component  xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript">
    <nts:parameter name="warningOnly" value="false"/>
    <variable>
        <name value="scenario-resource-id"/>
        <description value="Resource.id of the focal resource of this subscenario, used by Nictiz for quality checks"/>
        <expression nts:ifset="medicationSystem" value="Bundle.entry.select(resource as {$resourceType}).where($this.medication.resolve().code.coding.where(code = '{$medicationCode}' and system = '{$medicationSystem}')).id"/>
        <expression nts:ifnotset="medicationSystem" value="Bundle.entry.select(resource as {$resourceType}).where($this.medication.resolve().code.coding.where(code = '{$medicationCode}' and system = 'urn:oid:2.16.840.1.113883.2.4.4.10')).id"/>
        <sourceId value="searchset-response"/>
    </variable>
    <action>
        <assert>
            <description value="Confirm that the returned searchset Bundle contains the {$resourceType} resource, with id ${scenario-resource-id}, for this specific subscenario."/>
            <direction value="response"/>
            <expression nts:ifset="medicationSystem" value="Bundle.entry.select(resource as {$resourceType}).medication.resolve().code.coding.where(code = '{$medicationCode}' and system = '{$medicationSystem}').exists()"/>
            <expression nts:ifnotset="medicationSystem" value="Bundle.entry.select(resource as {$resourceType}).medication.resolve().code.coding.where(code = '{$medicationCode}' and system = 'urn:oid:2.16.840.1.113883.2.4.4.10').exists()"/>
            <warningOnly value="{$warningOnly}"/>
        </assert>
    </action>
    <action>
        <assert>
            <description value="Confirm that the returned searchset Bundle contains the Medication resource for this specific subscenario."/>
            <direction value="response"/>
            <expression nts:ifset="medicationSystem" value="Bundle.entry.select(resource as Medication).code.coding.where(code = '{$medicationCode}' and system = '{$medicationSystem}').exists()"/>
            <expression nts:ifnotset="medicationSystem" value="Bundle.entry.select(resource as Medication).code.coding.where(code = '{$medicationCode}' and system = 'urn:oid:2.16.840.1.113883.2.4.4.10').exists()"/>
            <warningOnly value="{$warningOnly}"/>
        </assert>
    </action>
</nts:component>